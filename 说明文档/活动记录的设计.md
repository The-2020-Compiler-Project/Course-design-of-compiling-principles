# 活动记录的设计和一些约定

好想反恐啊...

## 汇编中使用活动记录的一些约定

有点乱，我还没想好，可以不看

目前我准备使用汇编的ss段来作为一切变量和常量的存储空间。通过维护两个指针bp（帧指针），sp（栈指针）来表示一个过函的活动记录。一切指针和形参的操作应该在调用函数之前处理完成，在取出返回值后弹栈。存储操作类似于汇编课中讲过的赋给[低位址]。

在想要调用函数的时候，首先应该保存当前bp的值（ppt中的old sp），然后通过push或sub sp操作来开辟新的空间用于存储形参个数，形参内容，局部变量（或常量），返回地址。

在结束调用（ret指令执行完毕后）bp和sp还是调用结束的函数的值，也就是说现在活动记录还没删除，这时进行返回值操作，取出返回值赋给应该赋给的变量。然后把sp变为bp的值（也就是说将sp放到bp的位置，此时活动记录中只剩下old sp）。此时通过old sp找到主调函数活动记录开始的位置，设置bp，这一步可以通过pop bp实现，或者手动取值之后sub sp。

这之后一个函数的调用就结束了，此时活动记录变为主调函数，bp和sp在底和顶。

## 活动记录设计

最上面为bp（活动变量的底），最下面为sp（活动变量的顶）

通过查表确定返回值的长度

通过查询被调函数活动记录的层数l（从0开始），确定Display表的长度（l+1，从主调函数中拷贝l个display记录，然后加上自己活动记录的开始位置）

bp有一个确定数值（由汇编决定），调用变量时先在符号表中查找变量的偏移量，再结合bp计算出实际位置（函数内的变量应该是[bp-xxx]）

活动变量长度确定后，bp指向old sp，sp指向返回地址

| old sp                  2个存储单元（16位）                  |
| ------------------------------------------------------------ |
| 返回值                  1/2个存储单元（8/16位）              |
| Display表             每个记录2个存储单元（16位）  //可以通过先查表确定返回值的长度来确定位置 |
| 形参值                  按照形参的长度来，每个形参不是占1个单元就是占2个单元 |
| 局部变量              按照局部变量的长度来，每个局部变量不是占1个单元就是占2个单元 |
| 返回地址              2个存储单元（16位）                    |
|                                                              |
|                                                              |
|                                                              |
|                                                              |
|                                                              |

## 函数调用的目标代码大体步骤

有点乱，我先把简单的搞定再说

​	


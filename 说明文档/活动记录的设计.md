# 活动记录的设计和一些约定

好想反恐啊...

## 汇编中使用活动记录的一些约定

有点乱，我还没想好，可以不看

目前我准备使用汇编的ss段来作为一切变量和常量的存储空间。通过维护两个指针bp（帧指针），sp（栈指针）来表示一个过函的活动记录。一切指针和形参的操作应该在调用函数之前处理完成，在取出返回值后弹栈。存储操作类似于汇编课中讲过的赋给[低位址]。

在想要调用函数的时候，首先应该保存当前bp的值（ppt中的old sp），然后通过push或sub sp操作来开辟新的空间用于存储形参个数，形参内容，局部变量（或常量），返回地址。

在结束调用（ret指令执行完毕后）bp和sp还是调用结束的函数的值，也就是说现在活动记录还没删除，这时进行返回值操作，取出返回值赋给应该赋给的变量。然后把sp变为bp的值（也就是说将sp放到bp的位置，此时活动记录中只剩下old sp）。此时通过old sp找到主调函数活动记录开始的位置，设置bp，这一步可以通过pop bp实现，或者手动取值之后sub sp。

这之后一个函数的调用就结束了，此时活动记录变为主调函数，bp和sp在底和顶。

## 活动记录设计

最上面为bp（活动变量的底），最下面为sp（活动变量的顶）

通过查表确定返回值的长度

通过查询被调函数活动记录的层数l（从0开始），确定Display表的长度（l+1，从主调函数中拷贝l个display记录，然后加上自己活动记录的开始位置）

bp有一个确定数值（由汇编决定），调用变量时先在符号表中查找变量的偏移量，再结合bp计算出实际位置（函数内的变量应该是[bp-xxx]）

活动变量长度确定后，bp指向old sp，sp指向返回地址

| old sp                  2个存储单元（16位）                  |
| ------------------------------------------------------------ |
| 返回值                  1/2个存储单元（8/16位）              |
| Display表             每个记录2个存储单元（16位）  //可以通过先查表确定返回值的长度来确定位置 |
| 形参值                  按照形参的长度来，每个形参不是占1个单元就是占2个单元 |
| 局部变量              按照局部变量的长度来，每个局部变量不是占1个单元就是占2个单元 |
| //下面的是目标代码生成时应该做的，和符号表没啥关系                 |
| 传给他的被调函数的形参的值                                                             |
| 返回地址，在函数声明中通过ret返回                                                              |
| 之后接下一个函数的活动记录                                                            |
|                                                              |
|                                                              |

## 函数调用的目标代码大体步骤

有点乱，我先把简单的搞定再说

首先约定，每一个函数生成自己的活动记录的时刻是在自己开始运行的时候，也就是说我应该在函数声明对应的汇编代码中进行这部分操作。

函数需要的参数首先会在活动记录表的后面按照顺序给出。因为这个顺序是我定的，和符号表没关系，所以我可以在发现调用函数四元式之前的传参四元式时，将其翻译为对display表顶端后面的存储单元赋值的语句（直接赋值或者push都可以）。因为我知道有多少个参数和每个参数的大小，所以我可以通过调用函数后的bp加上对应的值确定位置。

函数调用结束后应该已经通过ret返回到了还没开始调用的位置（传参结束的位置），之后就可以通过调取被调函数返回值长度之后再通过计算得到位置，取出来。之后再赋给对应的变量，就结束了。

### 函数声明时的目标代码大体步骤

进入函数后，形参的值和返回位置在主调函数的bp-xxx里面。首先需要把主调的bp加进去，为old sp。然后sp-1或2（为返回值的地址，通过符号表得到）。然后通过old sp找到主调函数的起始位置，通过偏移量（他的old sp，返回值之后就是display开始的位置）复制被调函数嵌套层数l层的内容，然后被调函数加入l+1层，为被调函数的开始位置。然后通过bp找到（加上返回地址长度就是最后一个参数的位置）参数的值，加入被调函数的活动记录中。

如果被调函数还有调用函数的话就按照之前说过的做。

都结束了，该返回了。首先将寄存器清空，然后将sp移到bp的位置。然后pop bp，将bp变成主调函数开始的位置，将sp变成还没开始调用的位置（传参结束的位置）。然后主调函数就可以开始了。
